---
title: "RNA-seq analysis (NK)"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(edgeR)
library(limma)
library(omisc) 
library(d10misc) 
library(ComplexHeatmap)
```

# Load data

```{r}
x <- read_rds("/Users/sunxin/Documents/Projects/atacseq/RNAseq/output/rnaseq/dge.rds")
x
```


# Filter and normalize

```{r}
keep <- rowSums(cpm(x) > 10) >= 2
table(keep)
x <- x[keep, , keep.lib.sizes = TRUE]

x <- calcNormFactors(x, method = "TMM")
```


# Statistical analysis

```{r}
design <- model.matrix(~ 0 + group, x$samples)
rownames(design) <- colnames(x)
colnames(design) <- sub("group", "", colnames(design))
design
```


```{r}
v <- voom(x, design, plot = FALSE, save.plot = TRUE)
plot_voom(v)
```


```{r}
fit <- lmFit(v, design)
```


```{r}
con <- makeContrasts(
  background = (KO.Ctl + KO.Sti) / 2  - (WT.Ctl + WT.Sti) / 2,
  condition = (WT.Sti + KO.Sti) / 2  - (WT.Ctl + KO.Ctl) / 2,
  KO = KO.Sti - KO.Ctl,
  WT = WT.Sti - WT.Ctl,
  Sti = KO.Sti - WT.Sti,
  Ctl = KO.Ctl - WT.Ctl,
  levels = design
)
con

fit2 <- contrasts.fit(fit, con)

fit2 <- eBayes(fit2)
```


```{r}
to_tidy(fit2$p.value, "gene", "group", "p.value") %>%
  filter(group != "(Intercept)") %>%
  ggplot(aes(p.value)) +
    geom_histogram(binwidth = .01) + 
    facet_wrap(~group)
```



```{r}
topTable(fit2)
```


```{r}
top <- topTable(fit2, coef = "condition", number = Inf)
head(top)
```



```{r}
res <- decideTests(fit2, p.value = 0.01)
head(res)
```


# Functional enrichment

## GO

```{r}
go <- goana(fit2, coef = "Ctl", FDR = 0.01, species = "Mm")
```


```{r}
topGO(go, "Up", ontology = "BP")
topGO(go, "Down", ontology = "BP")
```

## Fig.S5H
```{r}
plot_enrichment(go, ontology = "MF")
```

# Session information

```{r}
sessionInfo()
```